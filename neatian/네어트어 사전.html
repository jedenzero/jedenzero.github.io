<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
	  <meta http-equiv="X-UA-Compatible" content="IE=edge">
	  <meta name="viewport" content="width=device-width, initial-scale=1.0">
	  <title>네어트어</title>
    <link rel="stylesheet" href="../grayblue.css">
  </head>
  <body>
    <div class="header" style="display:flex;justify-content:space-between;">
      <a style="margin-left:20px;color:#1D2F52;font-size:15px;" href="https://jedenzero.github.io/neatian/">NEĂTĂK</a>
      <div id="numeronnetwork" style="display:flex;justify-content:center;align-items:center;width:30px;height:30px;border-radius:15px;margin-right:20px;margin-top:10px;color:#F5F5F5;background-color:#1D2F52;font-size:10px;" onclick="graph()">
        <i class="fi fi-br-chart-network"></i>
      </div>
    </div>
    <div class="contain" id="contain" style="width:260px;">
    <p id="total_amount"></p>
    <div class="underline" id="underline">
      <input type="text" id="search" onkeyup="search()">
    </div>
    <p id="search_amount"></p>
    <div id="output"></div>
    <div style="height:100px;"></div>
    </div>
    <div id="floating">
      <h2 style="text-align:center;">범위 제한</h2>
      <h3>품사</h3>
      <div class="limit" onclick="limit(this)">명사</div>
      <div class="limit" onclick="limit(this)">동사</div>
      <div class="limit" onclick="limit(this)">조사</div>
      <div class="limit" onclick="limit(this)">부사</div>
      <div class="limit" onclick="limit(this)">접속사</div>
      <div class="limit" onclick="limit(this)">전접사</div>
      <div class="limit" onclick="limit(this)">후접사</div>
      <div class="limit" onclick="limit(this)">접두사</div>
      <div class="limit" onclick="limit(this)">접미사</div>
      <h3>세부 분류</h3>
      <div class="timil" onclick="timil(this)">초기 네어트어</div>
      <div class="limit" onclick="timil(this)">민중 네어트어</div>
      <div class="timil" onclick="timil(this)">예타뷔스 방언</div>
      <div style="text-align:center;margin-top:10px;">
        <i class="fi fi-br-cross" onclick="visible()"></i>
      </div>
    </div>
    <div id="gnitaolf" onclick="visible()">
      <i class="fi fi-br-bars-filter"></i>
    </div>
    <div id="graphbox" style="display:none;height:500px;"></div>
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/sigma.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/1.2.1/plugins/sigma.layout.forceAtlas2.min.js"></script>
  <script>
    const contain = document.getElementById('contain');
    const graphBox = document.getElementById('graphbox');
    const input = document.getElementById('search');
    const output = document.getElementById('output');
    const totalAmount = document.getElementById('total_amount');
    const searchAmount = document.getElementById('search_amount');
    const fl = document.getElementById('floating');
    const lf = document.getElementById('gnitaolf');
    const detailCodes = {"초기 네어트어":"γo", "민중 네어트어":"ze", "예타뷔스 방언":"je"};
    const partColors = {"명사":0, "동사":0, "조사":0, "부사":0, "접속사":0, "전접사":0, "후접사":0, "접두사":0, "접미사":0};
    const detailColors = Object.entries(detailCodes).reduce((acc, [key, value]) => ({...acc, [key]: 1}), {});
    const detailNames = Object.entries(detailCodes).reduce((acc, [key, value]) => ({...acc, [value]: key}), {});
    const limitarr = [];
    const timilarr = Object.entries(detailCodes).map(row=>row[1]);
    let MatchT = [];
    let dataT = [];
    let variable = 0;
    let graphX = 0;
    let g = null;
    var ForceAtlas2Config = {
          barnesHutOptimize:true,
          scalingRatio:20,
          gravity:2,
          dissuadeHubs:true,
          coolDown:0.99,
          zoomMin:0.1,
          zoomMax:10
    };
    
    detailColors["민중 네어트어"]=0;
    timilarr.splice(timilarr.indexOf('ze'),1);
    
    function search() {
      const keyword = input.value;

      fetch('https://sheets.googleapis.com/v4/spreadsheets/13LICoyhYt4Do9R24ktfoDpSDFxhHKpO-r44P3ROTJZQ/values/ne!A:E?key=AIzaSyATLeHQh6kM0LWRJjLg8CmzoSdnntFrmFk')
      .then(response => response.json())
      .then(data => {
        let Match = data.values.filter(row=>row[0].includes(keyword)||row[2].includes(keyword));
        Match = Match.filter(row=>!limitarr.includes(row[1]));
        Match = Match.filter(row=>!timilarr.includes(row[3]));
        MatchT = Match;
        dataT = data.values;
        
        let exactMatch = Match.filter(row=>row[0]===(keyword)||row[2].split(', ').includes(keyword));
        let startMatch = Match.filter(row=>row[0].startsWith(keyword)&&row[0]!==keyword);
        let otherMatch = Match.filter(row=>!exactMatch.includes(row)&&!startMatch.includes(row));

        totalAmount.innerHTML = '현재 총 단어수 : '+data.values.length+'개'
        searchAmount.innerHTML = '검색 결과 : '+Match.length+'개'
        output.innerHTML = '';
        
        exactMatch.forEach((row, index)=>createWordElement(index+1,row,data));
        startMatch.forEach ((row, index)=>createWordElement(index+1+exactMatch.length,row,data));
        otherMatch.forEach((row, index)=>createWordElement(index+1+exactMatch.length+startMatch.length,row,data));
      })
      .catch(error => console.error('Error:', error));
    }
    function createWordElement(id,dat, data) {
      const div=document.createElement('div');
      const derive=[];
      div.className='word';
      div.innerHTML+='<sup>'+id+'</sup>'+'<h2 style="display:inline-block;margin-bottom:0;"><b>'+dat[0]+'</b>';
      div.innerHTML+='</h2><div style="display:inline-block;margin-left:5px;" onclick="agraph('+dat+')"><i class="fi fi-br-chart-network"></i></div>';
  	  if (dat[4]){
        div.innerHTML+='<div style="margin:0;padding:0;">'
        if(dat[4].indexOf('/')!==0){
            div.innerHTML+='<div style="display:inline-block;" onclick="go(this)">'+dat[4].split('/')[0].split(', ')[0]+'</div>'
            if(dat[4].split('/')[0].split(', ')[1]){
              dat[4].split('/')[0].split(', ').slice(1).forEach(el=>{
                div.innerHTML+='<div style="display:inline-block;margin-left:2px;margin-right:2px;">+</div><div style="display:inline-block;" onclick="go(this)">'+el+'</div>'
              });
            }
        }
        if(dat[4].indexOf('/')>0){
          div.innerHTML+='<div style="display:inline-block;width:2px;"></div>'
        }
        if(dat[4].indexOf('/')>=0){
          div.innerHTML+='<div style="display:inline-block;margin-right:2px;">&lt;</div><div style="display:inline-block;" onclick="go(this)">'+dat[4].slice(dat[4].indexOf('/')+1)+'</div>'
        }
        div.innerHTML+='</div>'
      }
      div.innerHTML+='<p>'
  	  div.innerHTML+=dat[1]+'<br>';
  	  if (dat[3]!=="ze"){
        div.innerHTML+='['+detailNames[dat[3]]+'] '
      }
      div.innerHTML+=dat[2];
  	  data.values.map(row => {
        if (row.length > 4) {
          return row[4];
        }
  	    else {
          return null;
        }
      }).forEach(el => {
        if (el&&el.split(', ').includes(dat[0])&&el.indexOf('/')!==0) {
          derive.push(data.values[data.values.map(row=>row[4]).indexOf(el)][0]);
        }
      });
  	  if (derive.length!==0){
  	    div.innerHTML+='<h4>합성어/파생어</h4><ul>'
        derive.forEach(el=>{
      		div.innerHTML+='<li onclick="go(this)">'+el+'</li>'
      	 });
      	 div.innerHTML+='</ul>'
      }
  	  div.innerHTML+='</p>'
      output.appendChild (div);
    }
    function go(element){
      input.value=element.innerText;
      search();
    }
    function limit(element){
      if (partColors[element.innerText]===0){
        element.style.backgroundColor="#F5F5F5";
        element.style.color="#374052";
        limitarr.push(element.innerText);
      }
      else{
        element.style.backgroundColor="#1D2F52";
        element.style.color="#F5F5F5";
        limitarr.splice(limitarr.indexOf(element.innerText),1);
      }
      partColors[element.innerText]=1-partColors[element.innerText];
      search();
    }
    function timil(element){
      if (detailColors[element.innerText]===0){
        element.style.backgroundColor="#F5F5F5";
        element.style.color="#374052";
        timilarr.push(detailCodes[element.innerText]);
      }
      else{
        element.style.backgroundColor="#1D2F52";
        element.style.color="#F5F5F5";
        timilarr.splice(timilarr.indexOf(detailCodes[element.innerText]),1);
      }
      detailColors[element.innerText]=1-detailColors[element.innerText];
      search();
    }
    function visible(){
      if (variable===0){
        fl.style.visibility="hidden";
        lf.style.visibility="visible";
      }
      else{
        fl.style.visibility="visible";
        lf.style.visibility="hidden";
      }
      variable=1-variable;
    }
    function graph(){
      if(graphX===0){
        contain.style.display = 'none';
        graphbox.style.display = 'block';
        fl.style.visibility="hidden";
        lf.style.visibility="hidden";
        document.getElementById('numeronnetwork').style.backgroundColor='#F5F5F5';
        document.getElementById('numeronnetwork').style.color='#374052';
        g = new sigma({
          graph:{
            nodes:[],
            edges:[]
          },
          container:'graphbox',
          settings:{
            drawLabels:true,
            defaultEdgeType:'arrow',
            defaultFont:window.getComputedStyle(document.body).fontFamily,
            defaultLabelColor:'#1D2F52'
          }
        });
        
        MatchT.forEach(row=>{
          if(!g.graph.nodes().find(node=>node.id===row[0]))
          g.graph.addNode({
            id:row[0],
            label:row[0],
            x:Math.random(),
            y:Math.random(),
            size:1,
            color:'#374052'
          })
        });
        MatchT.forEach(row=>{
          parent(row);
        });
        g.refresh();
        g.startForceAtlas2(ForceAtlas2Config);
        setTimeout(function(){
          g.stopForceAtlas2();
        },500);
        g.cameras[0].goTo({
          ratio:4
        });
      }
      else{
        g.stopForceAtlas2();
        g.graph.clear();
        g.refresh();
        contain.style.display = 'block';
        graphbox.style.display = 'none';
        fl.style.visibility="hidden";
        lf.style.visibility="visible";
        document.getElementById('numeronnetwork').style.backgroundColor='#1D2F52';
        document.getElementById('numeronnetwork').style.color='#F5F5F5';
      }
      graphX=1-graphX;
      search();
    }
    function parent(row){
      if(row[4]){
        if(row[4].indexOf('/')===-1){
          row[4].split(', ').forEach(el=>{
            if(!g.graph.nodes().find(node=>node.id===el)){
              g.graph.addNode({
                id:el,
                label:el,
                x:Math.random(),
                y:Math.random(),
                size:1,
                color:'#525F7A'
              })
            }
            if(!g.graph.edges().find(edge=>edge.id===el+'-'+row[0])){
              g.graph.addEdge({
                id:el+'-'+row[0],
                source:el,
                target:row[0],
                color:'#CEDBF5'
              })
            }
            dataT.filter(roww=>roww[0]===el).forEach(ell=>{
              parent(ell);
            });
          });
        }
        else{
          let el=row[4].slice(1);
            if(!g.graph.nodes().find(node=>node.id===el)){
              g.graph.addNode({
                id:el,
                label:el,
                x:Math.random(),
                y:Math.random(),
                size:1,
                color:'#525F7A'
              })
            }
            if(!g.graph.edges().find(edge=>edge.id===el+'-'+row[0])){
              g.graph.addEdge({
                id:el+'-'+row[0],
                source:el,
                target:row[0],
                color:'#CEDBF5'
              })
            }
            dataT.filter(roww=>roww[0]===el).forEach(ell=>{
              parent(ell);
            });
        }
      }
    }
    function agraph(element){
      MatchT=[element];
      graph();
    }
    search();
    visible();
  </script>
</html>
